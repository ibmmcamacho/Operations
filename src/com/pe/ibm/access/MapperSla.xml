<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.pe.ibm.access.MapperSla">
	<resultMap id = "result" type = "com.pe.ibm.bean.BeanSla">
	  <result property = "fecha" column = "FECHA_CREACION"/>
	  <result property = "ejecutado_man" column = "RESUELTOS_MANANA"/>
	  <result property = "tiempo_man" column = "TIEMPO_MAN"/>
	  <result property = "total_man" column = "TOTAL_MANANA"/>
	  <result property = "tickets_man" column = "TICKETS_MANANA"/>  
	  <result property = "ejecutado_tar" column = "RESUELTOS_TARDE"/>
	  <result property = "tiempo_tar" column = "TIEMPO_TARDE"/>
	  <result property = "total_tar" column = "TOTAL_TARDE"/>
	  <result property = "tickets_tar" column = "TICKETS_TARDE"/>
	  <result property = "porcentaje_man" column = "PORCENTAJE_MANANA"/>
	  <result property = "porcentaje_tar" column = "PORCENTAJE_TARDE"/>
   	</resultMap>
     
    <select id = "listarticketsla" resultMap = "result" parameterType = "com.pe.ibm.bean.BeanSla">     
     	<![CDATA[SELECT
TIK.FECHA_CREACION,
LISTAGG(TIK.CODIGOTICKET, ', ') AS TICKETS_TOTAL_MANANA,

COUNT(CASE WHEN TIME(FECHA) >= '00:00:00' AND TIME(FECHA) < '12:00:01' AND ACTUAL_FINISH < DATE(FECHA_CREACION)||' '||'16:00:00' 
OR TIME(FECHA) >= '18:00:00' AND TIME(FECHA) <= '23:59:59' AND ACTUAL_FINISH < DATE(FECHA_CREACION)||' '||'16:00:00'
THEN 1 ELSE NULL END ) AS RESUELTOS_MANANA,


SUM((CASE WHEN TIME(FECHA) >= '00:00:00' AND TIME(FECHA) < '12:00:01' AND ACTUAL_FINISH < DATE(FECHA_CREACION)||' '||'16:00:00' 
OR TIME(FECHA) >= '18:00:00' AND TIME(FECHA) <= '23:59:59' AND ACTUAL_FINISH < DATE(FECHA_CREACION)||' '||'16:00:00'
THEN TIMESTAMPDIFF(4,char((ACTUAL_FINISH)-TIMESTAMP(ACTUAL_START))) ELSE NULL END)) AS TIEMPO_MAN,

COUNT(CASE WHEN TIME(FECHA) >= '00:00:00' AND TIME(FECHA) < '12:00:01' AND STATUS NOT IN('CANCELLED')
OR TIME(FECHA) >= '18:00:00' AND TIME(FECHA) <= '23:59:59' AND STATUS NOT IN('CANCELLED')
THEN 1 ELSE NULL END ) AS TOTAL_MANANA,

LISTAGG((CASE WHEN TIME(FECHA) >= '00:00:00' AND TIME(FECHA) < '12:00:01' AND ACTUAL_FINISH > DATE(FECHA_CREACION)||' '||'16:00:00' 
OR TIME(FECHA) >= '18:00:00' AND TIME(FECHA) <= '23:59:59' AND ACTUAL_FINISH > DATE(FECHA_CREACION)||' '||'16:00:00' 
OR TIME(FECHA) >= '00:00:00' AND TIME(FECHA) < '12:00:01' AND STATUS NOT IN('RESOLVED','CLOSED','CANCELLED')
OR TIME(FECHA) >= '18:00:00' AND TIME(FECHA) <= '23:59:59' AND STATUS NOT IN('RESOLVED','CLOSED','CANCELLED')
THEN TIK.CODIGOTICKET ELSE NULL END), ', ') AS TICKETS_MANANA,

COUNT(CASE WHEN TIME(FECHA) >= '12:00:00' AND TIME(FECHA) < '18:00:01' AND ACTUAL_FINISH < DATE(FECHA_CREACION)||' '||'22:00:01' 
THEN 1 ELSE NULL END ) AS RESUELTOS_TARDE,

SUM((CASE WHEN TIME(FECHA) >= '12:00:00' AND TIME(FECHA) < '18:00:01' AND ACTUAL_FINISH < DATE(FECHA_CREACION)||' '||'22:00:01' 
THEN TIMESTAMPDIFF(4,char((ACTUAL_FINISH)-TIMESTAMP(ACTUAL_START))) ELSE NULL END)) AS TIEMPO_TARDE,

COUNT(CASE WHEN TIME(FECHA) >= '12:00:00' AND TIME(FECHA) < '18:00:01' AND STATUS NOT IN('CANCELLED')
THEN 1 ELSE NULL END ) AS TOTAL_TARDE,

LISTAGG((CASE WHEN TIME(FECHA) >= '12:00:00' AND TIME(FECHA) < '18:00:01' AND ACTUAL_FINISH > DATE(FECHA_CREACION)||' '||'22:00:00' 
OR TIME(FECHA) >= '12:00:00' AND TIME(FECHA) < '18:00:01' AND STATUS NOT IN('RESOLVED','CLOSED','CANCELLED')
THEN TIK.CODIGOTICKET ELSE NULL END), ', ') AS TICKETS_TARDE,

CASE WHEN (COUNT(CASE WHEN TIME(FECHA) >= '00:00:00' AND TIME(FECHA) < '12:00:01' AND ACTUAL_FINISH < DATE(FECHA_CREACION)||' '||'16:00:00' 
OR TIME(FECHA) >= '18:00:00' AND TIME(FECHA) <= '23:59:59' AND ACTUAL_FINISH < DATE(FECHA_CREACION)||' '||'16:00:00'
THEN 1 ELSE NULL END)) > 7 THEN 100 
WHEN COUNT(CASE WHEN TIME(FECHA) >= '00:00:00' AND FECHA < DATE(FECHA_CREACION)||' '||'12:00:00' AND STATUS NOT IN('CANCELLED') 
OR TIME(FECHA) >= '18:00:00' AND FECHA <= DATE(FECHA_CREACION)||' '||'23:59:59' AND STATUS NOT IN('CANCELLED')
THEN 1 ELSE NULL END) > 7 THEN 
dec((dec(COUNT(CASE WHEN TIME(FECHA) >= '00:00:00' AND TIME(FECHA) < '12:00:01' AND ACTUAL_FINISH < DATE(FECHA_CREACION)||' '||'16:00:00' 
OR TIME(FECHA) >= '18:00:00' AND TIME(FECHA) <= '23:59:59' AND ACTUAL_FINISH < DATE(FECHA_CREACION)||' '||'16:00:00'
THEN 1 ELSE NULL END)) / 7*100),7,2)
else dec((dec(COUNT(CASE WHEN TIME(FECHA) >= '00:00:00' AND TIME(FECHA) < '12:00:01' AND ACTUAL_FINISH < DATE(FECHA_CREACION)||' '||'16:00:00'
OR TIME(FECHA) >= '18:00:00' AND TIME(FECHA) <= '23:59:59' AND ACTUAL_FINISH < DATE(FECHA_CREACION)||' '||'16:00:00'
THEN 1 ELSE NULL END)) / nullif(dec(COUNT(CASE WHEN TIME(FECHA) >= '00:00:00' AND TIME(FECHA) < '12:00:01' AND STATUS NOT IN('CANCELLED')
OR TIME(FECHA) >= '18:00:00' AND TIME(FECHA) <= '23:59:59' AND STATUS NOT IN('CANCELLED')
THEN 1 ELSE NULL END)),0)*100),7,2) END as PORCENTAJE_MANANA,

CASE WHEN (COUNT(CASE WHEN TIME(FECHA) > '12:00:00' AND TIME(FECHA) < '18:00:01' AND ACTUAL_FINISH < DATE(FECHA_CREACION)||' '||'22:00:00' 
THEN 1 ELSE NULL END)) > 7 THEN 100 
WHEN COUNT(CASE WHEN TIME(FECHA_CREACION) > '12:00:00' AND FECHA < DATE(FECHA_CREACION)||' '||'18:00:00' AND STATUS NOT IN('CANCELLED')
THEN 1 ELSE NULL END) > 7 THEN 
dec((dec(COUNT(CASE WHEN TIME(FECHA) > '12:00:00' AND TIME(FECHA) < '18:00:01' AND ACTUAL_FINISH < DATE(FECHA_CREACION)||' '||'22:00:00'
THEN 1 ELSE NULL END)) / 7*100),7,2)
else dec((dec(COUNT(CASE WHEN TIME(FECHA) > '12:00:00' AND TIME(FECHA) < '18:00:01' AND ACTUAL_FINISH < DATE(FECHA_CREACION)||' '||'22:00:00'
THEN 1 ELSE NULL END)) / nullif(dec(COUNT(CASE WHEN TIME(FECHA) > '12:00:00' AND TIME(FECHA) < '18:00:00' AND STATUS NOT IN('CANCELLED')
THEN 1 ELSE NULL END)),0)*100),7,2) END as PORCENTAJE_TARDE

FROM
(
	SELECT
	T.REPORT_DATE FECHA,
	CASE 
	WHEN 
	(T.REPORT_DATE >= (DATE(T.REPORT_DATE)||' '||'18:00:00') AND T.REPORT_DATE <= (DATE(T.REPORT_DATE+3 days)||' '||'12:00:01')) AND DAYOFWEEK(T.REPORT_DATE) = 6
	THEN 
			DATE(T.REPORT_DATE+3 days) 
	WHEN 
	(T.REPORT_DATE >= (DATE(T.REPORT_DATE)||' '||'00:00:00') AND T.REPORT_DATE <= (DATE(T.REPORT_DATE+2 days)||' '||'12:00:01')) AND DAYOFWEEK(T.REPORT_DATE) = 7
	THEN 
			DATE(T.REPORT_DATE+2 days) 
	WHEN 
	(T.REPORT_DATE >= (DATE(T.REPORT_DATE)||' '||'00:00:00') AND T.REPORT_DATE <= (DATE(T.REPORT_DATE+1 days)||' '||'12:00:01')) AND DAYOFWEEK(T.REPORT_DATE) = 1
	THEN 
			DATE(T.REPORT_DATE+1 days)
	WHEN 
	(T.REPORT_DATE >= (DATE(T.REPORT_DATE)||' '||'18:00:00') AND T.REPORT_DATE <= (DATE(T.REPORT_DATE+1 days)||' '||'12:00:01')) AND DAYOFWEEK(T.REPORT_DATE) in (2,3,4,5)
	THEN 
			DATE(T.REPORT_DATE+1 days) 
	
	ELSE DATE(T.REPORT_DATE) END as FECHA_CREACION,
	T.COD_TICKET AS CODIGOTICKET,
	T.ACTUAL_FINISH	AS ACTUAL_FINISH,
	T.ACTUAL_START AS ACTUAL_START,
	T.STATUS AS STATUS
	FROM CONSUMOS.V_SAB_SCCD_IBM T
	WHERE T.REPORT_DATE >= #{fecha}||' 08:00:00' AND T.REPORT_DATE <= #{hasta}||' 18:00:01' 

	AND CLASS = 'SR' AND CLIENT_ID = 'PE-RIMAC-SO' 
	AND SUMMARY LIKE '%Pase No Productivo%']]> 
	<if test="resultado_tar == 'dbm'">
	<![CDATA[
	AND OWNER_GROUP_ID IN('I-DBM-IN-VIR01','I-DBM-IN-VIR02','I-DBM-IN-VIR03','I-DBM-PE-VIR01')
	]]>
	</if>
	<if test="resultado_tar == 'wme'">
	<![CDATA[
	AND OWNER_GROUP_ID IN('I-WME-IN-VIR01','I-WME-PE-VIR01','I-WME-PE-VIR02','I-WME-RIMAC-PE-VIR','I-WME-RIMAC-PE-VIR02')
	]]>
	</if>
	<![CDATA[ORDER BY 1 
) TIK
GROUP BY TIK.FECHA_CREACION]]>
    </select> 
    
</mapper>